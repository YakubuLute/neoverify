<!-- eslint-disable @angular-eslint/template/click-events-have-key-events -->
<!-- eslint-disable @angular-eslint/template/interactive-supports-focus -->
<div class="document-upload-container">
  <!-- Header Section -->
  <div class="document-upload-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          {{ uploadMode() === 'single' ? 'Upload Document' : 'Bulk Upload Documents' }}
        </h1>
        <p class="page-subtitle">
          {{
            uploadMode() === 'single'
              ? 'Upload and register your document on the blockchain for verification'
              : 'Upload multiple documents at once (up to 100 files)'
          }}
        </p>
      </div>

      <div class="header-actions">
        <!-- Upload Mode Toggle -->
        <div class="mode-toggle">
          <span class="toggle-label">Single</span>
          <p-toggleSwitch
            [(ngModel)]="isBulkModeValue"
            (onChange)="toggleUploadMode()"
            [disabled]="isUploading()"
          ></p-toggleSwitch>
          <span class="toggle-label">Bulk</span>
        </div>

        <p-button
          icon="pi pi-arrow-left"
          label="Back to Documents"
          (onClick)="cancel()"
          styleClass="p-button-text"
          pTooltip="Return to documents list"
        >
        </p-button>
      </div>
    </div>
  </div>

  <!-- Upload Content -->
  <div class="upload-content">
    <div class="upload-grid">
      <!-- Upload Section -->
      <div class="upload-section">
        <!-- Drag and Drop Upload Area -->
        <div class="upload-card">
          <div class="upload-card-content">
            <div class="upload-field">
              <p class="upload-field-label">Document File *</p>

              <!-- Drag and Drop Zone -->
              <div
                class="drag-drop-zone"
                [class.drag-over]="isDragOver()"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)"
                (click)="fileInput.click()"
              >
                @if (uploadMode() === 'single') { @if (!selectedFile()) {
                <div class="drop-zone-content">
                  <div class="drop-zone-icon">
                    <i class="pi pi-cloud-upload"></i>
                  </div>
                  <div class="drop-zone-text">
                    <p class="drop-zone-title">Drop your file here or click to browse</p>
                    <p class="drop-zone-subtitle">
                      Supported formats: PDF, DOCX, PNG, JPG, JPEG (Max:
                      {{ maxFileSize / 1024 / 1024 }}MB)
                    </p>
                  </div>
                </div>
                } @else {
                <div class="file-selected-content">
                  <div class="file-selected-icon">
                    <i class="pi pi-check"></i>
                  </div>
                  <div class="file-selected-info">
                    <p class="file-selected-name">
                      {{ selectedFile()?.name }}
                    </p>
                    <p class="file-selected-size">
                      {{ formatFileSize(selectedFile()?.size || 0) }}
                    </p>
                    <button type="button" class="file-remove-btn" (click)="removeFile($event)">
                      Remove file
                    </button>
                  </div>
                </div>
                } } @else { @if (selectedFiles().length === 0) {
                <div class="space-y-4">
                  <div
                    class="mx-auto w-16 h-16 bg-surface-100 dark:bg-surface-800 rounded-full flex items-center justify-center"
                  >
                    <i class="pi pi-cloud-upload text-2xl text-surface-500"></i>
                  </div>
                  <div>
                    <p class="text-lg font-medium text-surface-900 dark:text-surface-0 mb-2">
                      Drop multiple files here or click to browse
                    </p>
                    <p class="text-sm text-surface-500">
                      Upload up to 100 files at once<br />
                      Supported formats: PDF, DOCX, PNG, JPG, JPEG (Max:
                      {{ maxFileSize / 1024 / 1024 }}MB each)
                    </p>
                  </div>
                </div>
                } @else {
                <div class="space-y-4">
                  <div
                    class="mx-auto w-16 h-16 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center"
                  >
                    <i class="pi pi-files text-2xl text-green-600 dark:text-green-400"></i>
                  </div>
                  <div>
                    <p class="text-lg font-medium text-surface-900 dark:text-surface-0 mb-1">
                      {{ selectedFiles().length }} files selected
                    </p>
                    <p class="text-sm text-surface-500">Total size: {{ getTotalFileSize() }}</p>
                    <button
                      type="button"
                      class="mt-2 text-sm text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                      (click)="clearAllFiles($event)"
                    >
                      Clear all files
                    </button>
                  </div>
                </div>
                } }
              </div>

              <!-- Hidden file input -->
              <input
                title="Upload files"
                #fileInput
                type="file"
                class="hidden"
                [accept]="acceptedFileTypes"
                [multiple]="uploadMode() === 'bulk'"
                (change)="onFileInputChange($event)"
              />

              @if (fileError()) {
              <div class="error-message">
                <div class="error-content">
                  <i class="pi pi-exclamation-triangle error-icon"></i>
                  <span class="error-text">{{ fileError() }}</span>
                </div>
              </div>
              }
            </div>

            <!-- File Preview / Bulk File List -->
            @if (uploadMode() === 'single' && selectedFile() && filePreview()) {
            <div class="field">
              <p class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2">
                Preview
              </p>
              <div class="border rounded-lg p-4 bg-surface-50 dark:bg-surface-800">
                @if (isImageFile(selectedFile()!)) {
                <img
                  [src]="filePreview()"
                  [alt]="selectedFile()?.name"
                  class="max-w-full h-auto max-h-48 mx-auto rounded"
                />
                } @else {
                <div class="text-center py-8">
                  <i class="pi pi-file-pdf text-4xl text-red-500 mb-2"></i>
                  <p class="text-sm text-surface-600 dark:text-surface-400">PDF Preview</p>
                </div>
                }
              </div>
            </div>
            } @if (uploadMode() === 'bulk' && selectedFiles().length > 0) {
            <div class="field">
              <p class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2">
                Selected Files ({{ selectedFiles().length }})
              </p>
              <div
                class="border rounded-lg bg-surface-50 dark:bg-surface-800 max-h-64 overflow-y-auto"
              >
                @for (file of selectedFiles(); track file.name; let i = $index) {
                <div
                  class="flex items-center justify-between p-3 border-b border-surface-200 dark:border-surface-700 last:border-b-0"
                >
                  <div class="flex items-center space-x-3">
                    <div
                      class="w-8 h-8 bg-surface-200 dark:bg-surface-600 rounded flex items-center justify-center"
                    >
                      @if (isImageFile(file)) {
                      <i class="pi pi-image text-sm text-surface-600 dark:text-surface-400"></i>
                      } @else {
                      <i class="pi pi-file-pdf text-sm text-red-500"></i>
                      }
                    </div>
                    <div>
                      <p class="text-sm font-medium text-surface-900 dark:text-surface-0">
                        {{ file.name }}
                      </p>
                      <p class="text-xs text-surface-500">{{ formatFileSize(file.size) }}</p>
                    </div>
                  </div>
                  <button
                    type="button"
                    class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                    (click)="removeFileFromBulk(i)"
                  >
                    <i class="pi pi-times text-sm"></i>
                  </button>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>

        <!-- Upload Progress -->
        @if (uploadMode() === 'single' && uploadProgress()) {
        <div class="progress-card">
          <div class="progress-card-content">
            <div class="progress-card-header">
              <h3 class="progress-card-title">Upload Progress</h3>
              @if (uploadProgress()?.status === UploadStatus.UPLOADING || uploadProgress()?.status
              === UploadStatus.PROCESSING) {
              <p-button
                icon="pi pi-times"
                [text]="true"
                [rounded]="true"
                severity="danger"
                size="small"
                (onClick)="cancelUpload()"
                pTooltip="Cancel upload"
              ></p-button>
              }
            </div>

            <div class="progress-details">
              <div class="progress-info">
                <span class="progress-filename">{{ uploadProgress()?.fileName }}</span>
                <span class="progress-percentage">{{ uploadProgress()?.progress }}%</span>
              </div>

              <p-progressBar
                [value]="uploadProgress()?.progress || 0"
                [showValue]="false"
                class="h-2"
              ></p-progressBar>

              <div class="flex items-center text-sm">
                @switch (uploadProgress()?.status) { @case (UploadStatus.UPLOADING) {
                <i class="pi pi-spin pi-spinner text-blue-500 mr-2"></i>
                <span class="text-blue-600 dark:text-blue-400">Uploading...</span>
                } @case (UploadStatus.PROCESSING) {
                <i class="pi pi-spin pi-cog text-orange-500 mr-2"></i>
                <span class="text-orange-600 dark:text-orange-400">Processing...</span>
                } @case (UploadStatus.COMPLETED) {
                <i class="pi pi-check-circle text-green-500 mr-2"></i>
                <span class="text-green-600 dark:text-green-400">Upload completed</span>
                } @case (UploadStatus.FAILED) {
                <i class="pi pi-exclamation-triangle text-red-500 mr-2"></i>
                <span class="text-red-600 dark:text-red-400">Upload failed</span>
                } @case (UploadStatus.CANCELLED) {
                <i class="pi pi-times-circle text-gray-500 mr-2"></i>
                <span class="text-gray-600 dark:text-gray-400">Upload cancelled</span>
                } }
              </div>

              @if (uploadProgress()?.error) {
              <div
                class="p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800"
              >
                <p class="text-sm text-red-700 dark:text-red-300">{{ uploadProgress()?.error }}</p>
              </div>
              }
            </div>
          </div>
        </div>
        }

        <!-- Bulk Upload Progress -->
        @if (uploadMode() === 'bulk' && bulkUploadProgress().size > 0) {
        <div class="progress-card">
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-medium text-surface-900 dark:text-surface-0">
                Bulk Upload Progress
              </h3>
              <div class="text-sm text-surface-600 dark:text-surface-400">
                {{ totalBulkProgress() }}% Complete
              </div>
            </div>

            <!-- Overall Progress -->
            <div class="space-y-2">
              <p-progressBar
                [value]="totalBulkProgress()"
                [showValue]="false"
                class="h-3"
              ></p-progressBar>
            </div>

            <!-- Individual File Progress -->
            <div class="max-h-48 overflow-y-auto space-y-2">
              @for (progress of Array.from(bulkUploadProgress().values()); track progress.fileId) {
              <div
                class="flex items-center justify-between p-2 bg-surface-100 dark:bg-surface-700 rounded"
              >
                <div class="flex items-center space-x-2 flex-1 min-w-0">
                  <div class="w-4 h-4 flex-shrink-0">
                    @switch (progress.status) { @case (UploadStatus.UPLOADING) {
                    <i class="pi pi-spin pi-spinner text-blue-500 text-xs"></i>
                    } @case (UploadStatus.PROCESSING) {
                    <i class="pi pi-spin pi-cog text-orange-500 text-xs"></i>
                    } @case (UploadStatus.COMPLETED) {
                    <i class="pi pi-check-circle text-green-500 text-xs"></i>
                    } @case (UploadStatus.FAILED) {
                    <i class="pi pi-exclamation-triangle text-red-500 text-xs"></i>
                    } @case (UploadStatus.CANCELLED) {
                    <i class="pi pi-times-circle text-gray-500 text-xs"></i>
                    } @default {
                    <i class="pi pi-clock text-gray-500 text-xs"></i>
                    } }
                  </div>
                  <span class="text-sm text-surface-900 dark:text-surface-0 truncate">
                    {{ progress.fileName }}
                  </span>
                </div>
                <div class="flex items-center space-x-2 flex-shrink-0">
                  <span class="text-xs text-surface-600 dark:text-surface-400">
                    {{ progress.progress }}%
                  </span>
                  @if (progress.status === UploadStatus.UPLOADING || progress.status ===
                  UploadStatus.PROCESSING) {
                  <button
                    type="button"
                    class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                    (click)="cancelSingleUpload(progress.fileId)"
                  >
                    <i class="pi pi-times text-xs"></i>
                  </button>
                  }
                </div>
              </div>
              }
            </div>

            <!-- Bulk Upload Results -->
            @if (bulkUploadResults()) {
            <div class="p-3 bg-surface-50 dark:bg-surface-800 rounded border">
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-surface-900 dark:text-surface-0">Upload Summary</span>
              </div>
              <div class="mt-2 grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-lg font-bold text-green-600 dark:text-green-400">
                    {{ bulkUploadResults()?.success }}
                  </div>
                  <div class="text-xs text-surface-600 dark:text-surface-400">Success</div>
                </div>
                <div>
                  <div class="text-lg font-bold text-red-600 dark:text-red-400">
                    {{ bulkUploadResults()?.failed }}
                  </div>
                  <div class="text-xs text-surface-600 dark:text-surface-400">Failed</div>
                </div>
                <div>
                  <div class="text-lg font-bold text-surface-900 dark:text-surface-0">
                    {{ bulkUploadResults()?.total }}
                  </div>
                  <div class="text-xs text-surface-600 dark:text-surface-400">Total</div>
                </div>
              </div>
            </div>
            }
          </div>
        </div>
        }
      </div>

      <!-- Metadata Form -->
      <div class="metadata-section">
        <div class="metadata-card">
          <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()" class="metadata-form">
            <h3 class="metadata-card-title">Document Information</h3>

            <!-- Template Selection -->
            @if (availableTemplates().length > 0) {
            <div class="form-field">
              <label for="templateId" class="form-field-label">
                Document Template (Optional)
              </label>
              <div class="flex gap-2">
                <p-select
                  id="templateId"
                  formControlName="templateId"
                  [options]="getTemplateOptions()"
                  placeholder="Select a template to pre-fill fields"
                  class="flex-1"
                  [showClear]="true"
                ></p-select>
                @if (selectedTemplate()) {
                <p-button
                  icon="pi pi-eye"
                  [text]="true"
                  [rounded]="true"
                  severity="secondary"
                  size="small"
                  (onClick)="toggleTemplatePreview()"
                  pTooltip="Preview template"
                ></p-button>
                }
              </div>
              <small class="form-field-help">
                Templates help standardize document information and pre-fill common fields
              </small>
            </div>

            <!-- Template Preview -->
            @if (selectedTemplate() && showTemplatePreview()) {
            <div class="form-field">
              <div class="template-preview-card">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="text-sm font-medium text-surface-900 dark:text-surface-0">
                    {{ selectedTemplate()?.name }}
                  </h4>
                  <button
                    type="button"
                    class="text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200"
                    (click)="toggleTemplatePreview()"
                  >
                    <i class="pi pi-times text-sm"></i>
                  </button>
                </div>
                <p class="text-xs text-surface-600 dark:text-surface-400 mb-3">
                  {{ selectedTemplate()?.description }}
                </p>
                <div class="space-y-2">
                  <div class="text-xs font-medium text-surface-700 dark:text-surface-300">
                    Template Fields:
                  </div>
                  @for (field of selectedTemplate()?.fields || []; track field.id) {
                  <div class="flex items-center justify-between text-xs">
                    <span class="text-surface-600 dark:text-surface-400">
                      {{ field.name }}
                      @if (field.required) {
                      <span class="text-red-500">*</span>
                      }
                    </span>
                    <span class="text-surface-500 capitalize">{{ field.type }}</span>
                  </div>
                  }
                </div>
              </div>
            </div>
            } }

            <!-- Document Type -->
            <div class="form-field">
              <label for="documentType" class="form-field-label"> Document Type * </label>
              <p-select
                id="documentType"
                formControlName="documentType"
                [options]="documentTypeOptions"
                placeholder="Select document type"
                class="w-full"
                [class.ng-invalid]="isFieldInvalid('documentType')"
              ></p-select>
              @if (isFieldInvalid('documentType')) {
              <small class="p-error block mt-1">
                {{ getErrorMessage(uploadForm.get('documentType'), 'Document type') }}
              </small>
              }
            </div>

            <!-- Document Title -->
            <div class="form-field">
              <label for="title" class="form-field-label"> Document Title * </label>
              <input
                id="title"
                type="text"
                pInputText
                formControlName="title"
                placeholder="Enter document title"
                class="w-full"
                [class.ng-invalid]="isFieldInvalid('title')"
              />
              @if (titleSuggestions().length > 0) {
              <div class="mt-1">
                <small class="text-surface-500 block mb-1">Suggestions:</small>
                <div class="flex flex-wrap gap-1">
                  @for (suggestion of titleSuggestions(); track suggestion) {
                  <button
                    type="button"
                    class="px-2 py-1 text-xs bg-surface-100 dark:bg-surface-700 text-surface-700 dark:text-surface-300 rounded hover:bg-surface-200 dark:hover:bg-surface-600"
                    (click)="applySuggestion('title', suggestion)"
                  >
                    {{ suggestion }}
                  </button>
                  }
                </div>
              </div>
              } @if (isFieldInvalid('title')) {
              <small class="p-error block mt-1">
                {{ getErrorMessage(uploadForm.get('title'), 'Title') }}
              </small>
              }
            </div>

            <!-- Description -->
            <div class="field">
              <label
                for="description"
                class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2"
              >
                Description
              </label>
              <textarea
                id="description"
                pInputTextarea
                formControlName="description"
                placeholder="Enter document description (optional)"
                rows="3"
                class="w-full"
              ></textarea>
            </div>

            <!-- Tags -->
            <div class="field">
              <label
                for="tags"
                class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2"
              >
                Tags
              </label>
              <p-chips
                id="tags"
                formControlName="tags"
                placeholder="Add tags (press Enter to add)"
                class="w-full"
              ></p-chips>
              <small class="text-surface-500 mt-1 block">
                Add tags to help organize and search your documents
              </small>
            </div>

            <!-- Recipient Name (conditional) -->
            @if (showRecipientField()) {
            <div class="field">
              <label
                for="recipientName"
                class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2"
              >
                Recipient Name *
              </label>
              <input
                id="recipientName"
                type="text"
                pInputText
                formControlName="recipientName"
                placeholder="Enter recipient name"
                class="w-full"
                [class.ng-invalid]="isFieldInvalid('recipientName')"
              />
              @if (isFieldInvalid('recipientName')) {
              <small class="p-error block mt-1">
                {{ getErrorMessage(uploadForm.get('recipientName'), 'Recipient name') }}
              </small>
              }
            </div>
            }

            <!-- Issue Date -->
            <div class="field">
              <label
                for="issueDate"
                class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2"
              >
                Issue Date
              </label>
              <p-datepicker
                id="issueDate"
                formControlName="issueDate"
                placeholder="Select issue date"
                class="w-full"
                [showIcon]="true"
                [maxDate]="today"
              ></p-datepicker>
            </div>

            <!-- Expiry Date -->
            <div class="field">
              <label
                for="expiryDate"
                class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2"
              >
                Expiry Date
              </label>
              <p-datepicker
                id="expiryDate"
                formControlName="expiryDate"
                placeholder="Select expiry date (optional)"
                class="w-full"
                [showIcon]="true"
                [minDate]="minExpiryDate()"
              ></p-datepicker>
            </div>

            <!-- Custom Fields (if any) -->
            @if (customFields().length > 0) {
            <div class="space-y-4">
              <h4 class="text-md font-medium text-surface-900 dark:text-surface-0">
                Additional Information
              </h4>
              @for (field of customFields(); track field.id) {
              <div class="field">
                <label
                  [for]="field.id"
                  class="block text-sm font-medium text-surface-900 dark:text-surface-0 mb-2"
                >
                  {{ field.name }}
                  @if (field.required) {
                  <span class="text-red-500">*</span>
                  }
                </label>
                @switch (field.type) { @case ('text') {
                <input
                  [id]="field.id"
                  type="text"
                  pInputText
                  [formControlName]="'custom_' + field.id"
                  [placeholder]="field.placeholder || 'Enter ' + field.name.toLowerCase()"
                  class="w-full"
                />
                } @case ('textarea') {
                <textarea
                  [id]="field.id"
                  pInputTextarea
                  [formControlName]="'custom_' + field.id"
                  [placeholder]="field.placeholder || 'Enter ' + field.name.toLowerCase()"
                  rows="3"
                  class="w-full"
                ></textarea>
                } @case ('dropdown') {
                <p-select
                  [id]="field.id"
                  [formControlName]="'custom_' + field.id"
                  [options]="getFieldOptions(field)"
                  [placeholder]="'Select ' + field.name.toLowerCase()"
                  class="w-full"
                ></p-select>
                } @case ('date') {
                <p-datepicker
                  [id]="field.id"
                  [formControlName]="'custom_' + field.id"
                  [placeholder]="'Select ' + field.name.toLowerCase()"
                  class="w-full"
                  [showIcon]="true"
                ></p-datepicker>
                } }
              </div>
              }
            </div>
            }

            <!-- Auto Register Option -->
            <div class="field">
              <div class="flex items-center">
                <p-checkbox
                  formControlName="autoRegister"
                  inputId="autoRegister"
                  [binary]="true"
                  class="mr-2"
                ></p-checkbox>
                <label for="autoRegister" class="text-sm text-surface-600 dark:text-surface-400">
                  Automatically register on blockchain after upload
                </label>
              </div>
              <small class="text-surface-500 mt-1 block">
                If unchecked, you can register manually later from the document details page
              </small>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
              <p-button
                type="button"
                label="Cancel"
                icon="pi pi-times"
                styleClass="p-button-outlined"
                (onClick)="cancel()"
                [disabled]="isUploading()"
              ></p-button>

              <p-button
                type="submit"
                label="Upload Document"
                icon="pi pi-upload"
                styleClass="p-button-primary"
                [loading]="isUploading()"
                [disabled]="!canSubmit()"
              ></p-button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
