<div class="templates-list-container">
    <!-- Header Section -->
    <div class="templates-list-header">
        <div class="header-content">
            <div class="title-section">
                <h1 class="page-title">Document Templates</h1>
                <p class="page-subtitle">Manage and organize your document templates</p>
            </div>
            <div class="header-actions">
                @if (canCreateTemplate()) {
                <div class="create-btn">
                    <p-button label="Create Template" icon="pi pi-plus" (onClick)="onCreateTemplate()"
                        styleClass="p-button-primary">
                    </p-button>
                </div>
                }
                <p-button icon="pi pi-refresh" (onClick)="refreshTemplates()" styleClass="p-button-text"
                    pTooltip="Refresh templates">
                </p-button>
                <p-button [icon]="viewMode() === 'grid' ? 'pi pi-list' : 'pi pi-th-large'" (onClick)="toggleViewMode()"
                    styleClass="p-button-text"
                    [pTooltip]="viewMode() === 'grid' ? 'Switch to list view' : 'Switch to grid view'">
                </p-button>
                <p-button icon="pi pi-filter" (onClick)="toggleFilters()" styleClass="p-button-text"
                    [class.active]="showFilters()" pTooltip="Toggle filters">
                </p-button>
            </div>
        </div>
    </div>

    <!-- Search and Filters Section -->
    <div class="search-filters-section">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-input">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Search templates by name, description, or category..."
                        class="search-field" [value]="searchQuery()" (input)="onSearch($any($event.target).value)">
                </span>
            </div>
        </div>

        <!-- Filters Panel -->
        @if (showFilters()) {
        <div class="filters-panel">
            <div class="filters-content">
                <div class="filter-group">
                    <label>Category</label>
                    <p-multiSelect [options]="availableCategories().map(cat => ({label: cat, value: cat}))"
                        placeholder="Select categories" [ngModel]="filters().category || []"
                        (ngModelChange)="onFilterChange({...filters(), category: $event})">
                    </p-multiSelect>
                </div>

                <div class="filter-group">
                    <label>Status</label>
                    <p-select [options]="[
                {label: 'All', value: undefined},
                {label: 'Active', value: true},
                {label: 'Inactive', value: false}
              ]" placeholder="Select status" [ngModel]="filters().isActive"
                        (ngModelChange)="onFilterChange({...filters(), isActive: $event})">
                    </p-select>
                </div>

                <div class="filter-group">
                    <label>Created By</label>
                    <p-multiSelect [options]="availableCreators().map(creator => ({label: creator, value: creator}))"
                        placeholder="Select creators" [ngModel]="filters().createdBy || []"
                        (ngModelChange)="onFilterChange({...filters(), createdBy: $event})">
                    </p-multiSelect>
                </div>

                <div class="filter-group">
                    <label>Date Range</label>
                    <p-datePicker selectionMode="range" placeholder="Select date range"
                        [ngModel]="filters().dateRange ? [filters().dateRange!.start, filters().dateRange!.end] : null"
                        (ngModelChange)="onFilterChange({...filters(), dateRange: $event ? {start: $event[0], end: $event[1]} : undefined})">
                    </p-datePicker>
                </div>

                <div class="filter-actions">
                    <p-button label="Clear Filters" (onClick)="clearFilters()" styleClass="p-button-text">
                    </p-button>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Bulk Actions Bar -->
    @if (hasSelection()) {
    <div class="bulk-actions-bar">
        <div class="selection-info">
            {{ selectedTemplates().length }} template(s) selected
        </div>
        <div class="bulk-actions">
            @if (canManageTemplates()) {
            <p-button label="Activate" icon="pi pi-check" (onClick)="onBulkAction('activate')"
                styleClass="p-button-text">
            </p-button>
            <p-button label="Deactivate" icon="pi pi-times" (onClick)="onBulkAction('deactivate')"
                styleClass="p-button-text">
            </p-button>
            <p-button label="Delete" icon="pi pi-trash" (onClick)="onBulkAction('delete')"
                styleClass="p-button-text p-button-danger">
            </p-button>
            }
            <p-button label="Export" icon="pi pi-download" (onClick)="onBulkAction('export')"
                styleClass="p-button-text">
            </p-button>
        </div>
    </div>
    }

    <!-- Loading State -->
    @if (loading()) {
    <div class="loading-container">
        <div class="loading-content">
            <p-progressSpinner></p-progressSpinner>
            <p>Loading templates...</p>
        </div>
    </div>
    }

    <!-- Error State -->
    @else if (error()) {
    <div class="error-container">
        <div class="error-content">
            <i class="pi pi-exclamation-triangle error-icon"></i>
            <h3>Error Loading Templates</h3>
            <p>{{ error() }}</p>
            <p-button label="Try Again" icon="pi pi-refresh" (onClick)="refreshTemplates()">
            </p-button>
        </div>
    </div>
    }

    <!-- Empty State -->
    @else if (filteredTemplates().length === 0 && !loading()) {
    <div class="empty-container">
        <div class="empty-content">
            <i class="pi pi-file-o empty-icon"></i>
            <h3>No Templates Found</h3>
            @if (searchQuery() || Object.keys(filters()).length > 0) {
            <p>No templates match your current search and filter criteria.</p>
            <p-button label="Clear Filters" icon="pi pi-filter-slash" (onClick)="clearFilters()">
            </p-button>
            } @else {
            <p>Get started by creating your first document template.</p>
            @if (canCreateTemplate()) {
            <p-button label="Create Template" icon="pi pi-plus" (onClick)="onCreateTemplate()">
            </p-button>
            }
            }
        </div>
    </div>
    }

    <!-- Templates Content -->
    @else {
    <div class="templates-content">
        <!-- List Header -->
        <div class="list-header">
            <div class="selection-controls">
                <p-checkbox [binary]="true" [ngModel]="isAllSelected()" (ngModelChange)="onSelectAll()"
                    label="Select All">
                </p-checkbox>
            </div>
            <div class="sort-controls">
                <p-select [options]="[
              {label: 'Name', value: 'name'},
              {label: 'Category', value: 'category'},
              {label: 'Created Date', value: 'createdAt'},
              {label: 'Updated Date', value: 'updatedAt'},
              {label: 'Usage Count', value: 'usageCount'}
            ]" [ngModel]="sortBy()" (ngModelChange)="onSortChange($event, sortOrder())">
                </p-select>
                <p-button [icon]="sortOrder() === 'asc' ? 'pi pi-sort-amount-up' : 'pi pi-sort-amount-down'"
                    (onClick)="onSortChange(sortBy(), sortOrder() === 'asc' ? 'desc' : 'asc')"
                    styleClass="p-button-text">
                </p-button>
            </div>
        </div>

        <!-- Grid View -->
        @if (viewMode() === 'grid') {
        <div class="templates-grid">
            @for (template of filteredTemplates(); track template.id) {
            <div class="template-card">
                <div class="template-card-header">
                    <div class="template-selection">
                        <p-checkbox [binary]="true" [ngModel]="selectedTemplates().includes(template.id)"
                            (ngModelChange)="onTemplateSelect(template.id, $event)">
                        </p-checkbox>
                    </div>
                    <div class="template-status">
                        <p-tag [value]="template.isActive ? 'Active' : 'Inactive'"
                            [severity]="template.isActive ? 'success' : 'secondary'">
                        </p-tag>
                    </div>
                </div>

                <div class="template-preview" (click)="onTemplateClick(template)">
                    @if (template.previewUrl) {
                    <img [src]="template.previewUrl" [alt]="template.name" class="preview-image">
                    } @else {
                    <div class="preview-placeholder">
                        <i class="pi pi-file-o"></i>
                    </div>
                    }
                </div>

                <div class="template-info">
                    <h3 class="template-name" (click)="onTemplateClick(template)">{{ template.name }}</h3>
                    <p class="template-description">{{ template.description }}</p>

                    <div class="template-meta">
                        <div class="meta-item">
                            <i class="pi pi-tag"></i>
                            <span>{{ template.category }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="pi pi-code"></i>
                            <span>v{{ template.version }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="pi pi-calendar"></i>
                            <span>{{ formatDate(template.updatedAt) }}</span>
                        </div>
                    </div>

                    <!-- Usage Statistics -->
                    @if (getUsageStats(template.id); as stats) {
                    <div class="usage-stats">
                        <div class="usage-item">
                            <span class="usage-label">Total Usage:</span>
                            <span class="usage-value">{{ stats.totalUsage }}</span>
                        </div>
                        <div class="usage-item">
                            <span class="usage-label">Recent:</span>
                            <span class="usage-value">
                                {{ stats.recentUsage }}
                                <i [class]="getTrendIcon(stats.trendDirection)"
                                    [ngClass]="getTrendColor(stats.trendDirection)"></i>
                            </span>
                        </div>
                    </div>
                    }
                </div>

                <div class="template-actions">
                    <p-button icon="pi pi-eye" (onClick)="onTemplateClick(template)"
                        styleClass="p-button-text p-button-sm" pTooltip="View template">
                    </p-button>
                    @if (canCreateTemplate()) {
                    <p-button icon="pi pi-pencil" (onClick)="onEditTemplate(template)"
                        styleClass="p-button-text p-button-sm" pTooltip="Edit template">
                    </p-button>
                    <p-button icon="pi pi-copy" (onClick)="onDuplicateTemplate(template)"
                        styleClass="p-button-text p-button-sm" pTooltip="Duplicate template">
                    </p-button>
                    }
                    <p-button icon="pi pi-share-alt" (onClick)="onShareTemplate(template)"
                        styleClass="p-button-text p-button-sm" pTooltip="Share template">
                    </p-button>
                    <p-button icon="pi pi-history" (onClick)="onViewVersions(template)"
                        styleClass="p-button-text p-button-sm" pTooltip="View versions">
                    </p-button>
                    <p-button icon="pi pi-download" (onClick)="onExportTemplate(template, 'json')"
                        styleClass="p-button-text p-button-sm" pTooltip="Export template">
                    </p-button>
                    @if (canManageTemplates()) {
                    <p-button [icon]="template.isActive ? 'pi pi-pause' : 'pi pi-play'"
                        (onClick)="onToggleTemplateStatus(template)" styleClass="p-button-text p-button-sm"
                        [pTooltip]="template.isActive ? 'Deactivate template' : 'Activate template'">
                    </p-button>
                    <p-button icon="pi pi-trash" (onClick)="onDeleteTemplate(template)"
                        styleClass="p-button-text p-button-sm p-button-danger" pTooltip="Delete template">
                    </p-button>
                    }
                </div>
            </div>
            }
        </div>
        }

        <!-- List View -->
        @else {
        <div class="templates-table">
            <p-table [value]="filteredTemplates()" [paginator]="true" [rows]="pageSize()" [totalRecords]="totalCount()"
                [lazy]="true" (onLazyLoad)="onPageChange($event.first! / $event.rows! + 1)" styleClass="p-datatable-sm">

                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-checkbox [binary]="true" [ngModel]="isAllSelected()" (ngModelChange)="onSelectAll()">
                            </p-checkbox>
                        </th>
                        <th>Template</th>
                        <th>Category</th>
                        <th>Version</th>
                        <th>Status</th>
                        <th>Usage</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-template>
                    <tr>
                        <td>
                            <p-checkbox [binary]="true" [ngModel]="selectedTemplates().includes(template.id)"
                                (ngModelChange)="onTemplateSelect(template.id, $event)">
                            </p-checkbox>
                        </td>
                        <td>
                            <div class="template-info">
                                <div class="template-thumbnail">
                                    @if (template.previewUrl) {
                                    <img [src]="template.previewUrl" [alt]="template.name">
                                    } @else {
                                    <i class="pi pi-file-o template-icon"></i>
                                    }
                                </div>
                                <div class="template-details">
                                    <div class="template-title" (click)="onTemplateClick(template)">{{ template.name }}
                                    </div>
                                    <div class="template-description">{{ template.description }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="template.category" severity="info"></p-tag>
                        </td>
                        <td>v{{ template.version }}</td>
                        <td>
                            <p-tag [value]="template.isActive ? 'Active' : 'Inactive'"
                                [severity]="template.isActive ? 'success' : 'secondary'">
                            </p-tag>
                        </td>
                        <td>
                            @if (getUsageStats(template.id); as stats) {
                            <div class="usage-display">
                                <span>{{ stats.totalUsage }}</span>
                                <i [class]="getTrendIcon(stats.trendDirection)"
                                    [ngClass]="getTrendColor(stats.trendDirection)"></i>
                            </div>
                            } @else {
                            <span>{{ template.usageCount }}</span>
                            }
                        </td>
                        <td>{{ formatDate(template.updatedAt) }}</td>
                        <td>
                            <div class="action-buttons">
                                <p-button icon="pi pi-eye" (onClick)="onTemplateClick(template)"
                                    styleClass="p-button-text p-button-sm" pTooltip="View">
                                </p-button>
                                @if (canCreateTemplate()) {
                                <p-button icon="pi pi-pencil" (onClick)="onEditTemplate(template)"
                                    styleClass="p-button-text p-button-sm" pTooltip="Edit">
                                </p-button>
                                }
                                <p-button icon="pi pi-ellipsis-v" styleClass="p-button-text p-button-sm"
                                    pTooltip="More actions">
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        }

        <!-- Pagination -->
        @if (viewMode() === 'grid' && totalCount() > pageSize()) {
        <div class="pagination-container">
            <p-paginator [rows]="pageSize()" [totalRecords]="totalCount()" [first]="(currentPage() - 1) * pageSize()"
                (onPageChange)="onPageChange($event.page + 1)">
            </p-paginator>
        </div>
        }
    </div>
    }
</div>

<!-- Share Template Dialog -->
<p-dialog header="Share Template" [modal]="true" [visible]="showShareDialog()" (onHide)="showShareDialog.set(false)"
    [style]="{width: '500px'}">

    @if (selectedTemplate(); as template) {
    <div class="share-dialog-content">
        <h4>{{ template.name }}</h4>
        <p>Share this template with other users in your organization.</p>

        <!-- Share form would go here -->
        <div class="share-form">
            <div class="form-group">
                <label>Users</label>
                <p-multiSelect placeholder="Select users to share with" [options]="[]" styleClass="w-full">
                </p-multiSelect>
            </div>

            <div class="form-group">
                <label>Permissions</label>
                <div class="permission-checkboxes">
                    <p-checkbox label="Can View" [binary]="true"></p-checkbox>
                    <p-checkbox label="Can Edit" [binary]="true"></p-checkbox>
                    <p-checkbox label="Can Download" [binary]="true"></p-checkbox>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" (onClick)="showShareDialog.set(false)" styleClass="p-button-text">
        </p-button>
        <p-button label="Share" (onClick)="showShareDialog.set(false)">
        </p-button>
    </ng-template>
    }
</p-dialog>

<!-- Template Versions Dialog -->
<p-dialog header="Template Versions" [modal]="true" [visible]="showVersionDialog()"
    (onHide)="showVersionDialog.set(false)" [style]="{width: '700px'}">

    @if (selectedTemplate(); as template) {
    <div class="versions-dialog-content">
        <h4>{{ template.name }} - Version History</h4>

        <div class="versions-list">
            @for (version of templateVersions(); track version.id) {
            <div class="version-item" [class.active]="version.isActive">
                <div class="version-info">
                    <div class="version-header">
                        <span class="version-number">v{{ version.version }}</span>
                        @if (version.isActive) {
                        <p-tag value="Active" severity="success"></p-tag>
                        }
                    </div>
                    <p class="version-changes">{{ version.changes }}</p>
                    <div class="version-meta">
                        <span>{{ version.createdBy }}</span>
                        <span>{{ formatDate(version.createdAt) }}</span>
                    </div>
                </div>
                <div class="version-actions">
                    @if (!version.isActive && canManageTemplates()) {
                    <p-button label="Activate" (onClick)="onActivateVersion(template.id, version.id)"
                        styleClass="p-button-sm">
                    </p-button>
                    }
                    <p-button icon="pi pi-eye" styleClass="p-button-text p-button-sm" pTooltip="View version">
                    </p-button>
                </div>
            </div>
            }
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Close" (onClick)="showVersionDialog.set(false)" styleClass="p-button-text">
        </p-button>
        @if (canCreateTemplate()) {
        <p-button label="Create New Version" (onClick)="onCreateNewVersion(template)">
        </p-button>
        }
    </ng-template>
    }
</p-dialog>